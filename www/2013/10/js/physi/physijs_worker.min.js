"use strict";var transferableMessage=self.webkitPostMessage||self.postMessage,MESSAGE_TYPES={WORLDREPORT:0,COLLISIONREPORT:1,VEHICLEREPORT:2,CONSTRAINTREPORT:3},_object,_vector,_transform,public_functions={},getShapeFromCache,setShapeCache,createShape,reportWorld,reportVehicles,reportCollisions,reportConstraints,fixedTimeStep,rateLimit,last_simulation_time,last_simulation_duration=0,world,transform,_vec3_1,_vec3_2,_vec3_3,_quat,_objects={},_vehicles={},_constraints={},_materials={},_objects_ammo={},_num_objects=0,_num_wheels=0,_num_constraints=0,_object_shapes={},_motion_states={},_noncached_shapes={},_compound_shapes={},REPORT_CHUNKSIZE,WORLDREPORT_ITEMSIZE=14,worldreport,COLLISIONREPORT_ITEMSIZE=5,collisionreport,VEHICLEREPORT_ITEMSIZE=9,vehiclereport,CONSTRAINTREPORT_ITEMSIZE=6,constraintreport;var ab=new ArrayBuffer(1);transferableMessage(ab,[ab]);var SUPPORT_TRANSFERABLE=(ab.byteLength===0);getShapeFromCache=function(a){if(_object_shapes[a]!==undefined){return _object_shapes[a]}return null};setShapeCache=function(b,a){_object_shapes[b]=a};createShape=function(k){var c,h;_transform.setIdentity();switch(k.type){case"plane":c="plane_"+k.normal.x+"_"+k.normal.y+"_"+k.normal.z;if((h=getShapeFromCache(c))===null){_vec3_1.setX(k.normal.x);_vec3_1.setY(k.normal.y);_vec3_1.setZ(k.normal.z);h=new Ammo.btStaticPlaneShape(_vec3_1,0);setShapeCache(c,h)}break;case"box":c="box_"+k.width+"_"+k.height+"_"+k.depth;if((h=getShapeFromCache(c))===null){_vec3_1.setX(k.width/2);_vec3_1.setY(k.height/2);_vec3_1.setZ(k.depth/2);h=new Ammo.btBoxShape(_vec3_1);setShapeCache(c,h)}break;case"sphere":c="sphere_"+k.radius;if((h=getShapeFromCache(c))===null){h=new Ammo.btSphereShape(k.radius);setShapeCache(c,h)}break;case"cylinder":c="cylinder_"+k.width+"_"+k.height+"_"+k.depth;if((h=getShapeFromCache(c))===null){_vec3_1.setX(k.width/2);_vec3_1.setY(k.height/2);_vec3_1.setZ(k.depth/2);h=new Ammo.btCylinderShape(_vec3_1);setShapeCache(c,h)}break;case"capsule":c="capsule_"+k.radius+"_"+k.height;if((h=getShapeFromCache(c))===null){h=new Ammo.btCapsuleShape(k.radius,k.height-2*k.radius);setShapeCache(c,h)}break;case"cone":c="cone_"+k.radius+"_"+k.height;if((h=getShapeFromCache(c))===null){h=new Ammo.btConeShape(k.radius,k.height);setShapeCache(c,h)}break;case"concave":var d,e,b=new Ammo.btTriangleMesh;if(!k.triangles.length){return false}for(d=0;d<k.triangles.length;d++){e=k.triangles[d];_vec3_1.setX(e[0].x);_vec3_1.setY(e[0].y);_vec3_1.setZ(e[0].z);_vec3_2.setX(e[1].x);_vec3_2.setY(e[1].y);_vec3_2.setZ(e[1].z);_vec3_3.setX(e[2].x);_vec3_3.setY(e[2].y);_vec3_3.setZ(e[2].z);b.addTriangle(_vec3_1,_vec3_2,_vec3_3,true)}h=new Ammo.btBvhTriangleMeshShape(b,true,true);_noncached_shapes[k.id]=h;break;case"convex":var d,j,h=new Ammo.btConvexHullShape;for(d=0;d<k.points.length;d++){j=k.points[d];_vec3_1.setX(j.x);_vec3_1.setY(j.y);_vec3_1.setZ(j.z);h.addPoint(_vec3_1)}_noncached_shapes[k.id]=h;break;case"heightfield":var a=Ammo.allocate(4*k.xpts*k.ypts,"float",Ammo.ALLOC_NORMAL);for(var g=0;g<k.points.length;g++){Ammo.setValue(a+g,k.points[g],"float")}h=new Ammo.btHeightfieldTerrainShape(k.xpts,k.ypts,a,1,-k.absMaxHeight,k.absMaxHeight,2,0,false);_vec3_1.setX(k.xsize/(k.xpts-1));_vec3_1.setY(k.ysize/(k.ypts-1));_vec3_1.setZ(1);h.setLocalScaling(_vec3_1);_noncached_shapes[k.id]=h;break;default:return;break}return h};public_functions.init=function(d){importScripts(d.ammo);_transform=new Ammo.btTransform;_vec3_1=new Ammo.btVector3(0,0,0);_vec3_2=new Ammo.btVector3(0,0,0);_vec3_3=new Ammo.btVector3(0,0,0);_quat=new Ammo.btQuaternion(0,0,0,0);REPORT_CHUNKSIZE=d.reportsize||50;if(SUPPORT_TRANSFERABLE){worldreport=new Float32Array(2+REPORT_CHUNKSIZE*WORLDREPORT_ITEMSIZE);collisionreport=new Float32Array(2+REPORT_CHUNKSIZE*COLLISIONREPORT_ITEMSIZE);vehiclereport=new Float32Array(2+REPORT_CHUNKSIZE*VEHICLEREPORT_ITEMSIZE);constraintreport=new Float32Array(2+REPORT_CHUNKSIZE*CONSTRAINTREPORT_ITEMSIZE)}else{worldreport=[];collisionreport=[];vehiclereport=[];constraintreport=[]}worldreport[0]=MESSAGE_TYPES.WORLDREPORT;collisionreport[0]=MESSAGE_TYPES.COLLISIONREPORT;vehiclereport[0]=MESSAGE_TYPES.VEHICLEREPORT;constraintreport[0]=MESSAGE_TYPES.CONSTRAINTREPORT;var e=new Ammo.btDefaultCollisionConfiguration,b=new Ammo.btCollisionDispatcher(e),c=new Ammo.btSequentialImpulseConstraintSolver,a;if(!d.broadphase){d.broadphase={type:"dynamic"}}switch(d.broadphase.type){case"sweepprune":_vec3_1.setX(d.broadphase.aabbmin.x);_vec3_1.setY(d.broadphase.aabbmin.y);_vec3_1.setZ(d.broadphase.aabbmin.z);_vec3_2.setX(d.broadphase.aabbmax.x);_vec3_2.setY(d.broadphase.aabbmax.y);_vec3_2.setZ(d.broadphase.aabbmax.z);a=new Ammo.btAxisSweep3(_vec3_1,_vec3_2);break;case"dynamic":default:a=new Ammo.btDbvtBroadphase;break}world=new Ammo.btDiscreteDynamicsWorld(b,a,c,e);fixedTimeStep=d.fixedTimeStep;rateLimit=d.rateLimit;transferableMessage({cmd:"worldReady"})};public_functions.registerMaterial=function(a){_materials[a.id]=a};public_functions.unRegisterMaterial=function(a){delete _materials[a.id]};public_functions.setFixedTimeStep=function(a){fixedTimeStep=a};public_functions.setGravity=function(a){_vec3_1.setX(a.x);_vec3_1.setY(a.y);_vec3_1.setZ(a.z);world.setGravity(_vec3_1)};public_functions.addObject=function(j){var f,c,h,d,l,g;h=createShape(j);if(!h){return}if(j.children){var b=new Ammo.btCompoundShape,e;b.addChildShape(_transform,h);for(f=0;f<j.children.length;f++){e=j.children[f];var k=new Ammo.btTransform;k.setIdentity();_vec3_1.setX(e.position_offset.x);_vec3_1.setY(e.position_offset.y);_vec3_1.setZ(e.position_offset.z);k.setOrigin(_vec3_1);_quat.setX(e.rotation.x);_quat.setY(e.rotation.y);_quat.setZ(e.rotation.z);_quat.setW(e.rotation.w);k.setRotation(_quat);h=createShape(j.children[f]);b.addChildShape(k,h);Ammo.destroy(k)}h=b;_compound_shapes[j.id]=h}_vec3_1.setX(0);_vec3_1.setY(0);_vec3_1.setZ(0);h.calculateLocalInertia(j.mass,_vec3_1);_transform.setIdentity();_vec3_2.setX(j.position.x);_vec3_2.setY(j.position.y);_vec3_2.setZ(j.position.z);_transform.setOrigin(_vec3_2);_quat.setX(j.rotation.x);_quat.setY(j.rotation.y);_quat.setZ(j.rotation.z);_quat.setW(j.rotation.w);_transform.setRotation(_quat);d=new Ammo.btDefaultMotionState(_transform);l=new Ammo.btRigidBodyConstructionInfo(j.mass,d,h,_vec3_1);if(j.materialId!==undefined){l.set_m_friction(_materials[j.materialId].friction);l.set_m_restitution(_materials[j.materialId].restitution)}g=new Ammo.btRigidBody(l);Ammo.destroy(l);if(typeof j.collision_flags!=="undefined"){g.setCollisionFlags(j.collision_flags)}world.addRigidBody(g);g.id=j.id;_objects[g.id]=g;_motion_states[g.id]=d;var a=g.a!=undefined?g.a:g.ptr;_objects_ammo[a]=g.id;_num_objects++;transferableMessage({cmd:"objectReady",params:g.id})};public_functions.addVehicle=function(a){var c=new Ammo.btVehicleTuning(),b;c.set_m_suspensionStiffness(a.suspension_stiffness);c.set_m_suspensionCompression(a.suspension_compression);c.set_m_suspensionDamping(a.suspension_damping);c.set_m_maxSuspensionTravelCm(a.max_suspension_travel);c.set_m_maxSuspensionForce(a.max_suspension_force);b=new Ammo.btRaycastVehicle(c,_objects[a.rigidBody],new Ammo.btDefaultVehicleRaycaster(world));b.tuning=c;_objects[a.rigidBody].setActivationState(4);b.setCoordinateSystem(0,1,2);world.addVehicle(b);_vehicles[a.id]=b};public_functions.removeVehicle=function(a){delete _vehicles[a.id]};public_functions.addWheel=function(a){if(_vehicles[a.id]!==undefined){var b=_vehicles[a.id].tuning;if(a.tuning!==undefined){b=new Ammo.btVehicleTuning();b.set_m_suspensionStiffness(a.tuning.suspension_stiffness);b.set_m_suspensionCompression(a.tuning.suspension_compression);b.set_m_suspensionDamping(a.tuning.suspension_damping);b.set_m_maxSuspensionTravelCm(a.tuning.max_suspension_travel);b.set_m_maxSuspensionForce(a.tuning.max_suspension_force)}_vec3_1.setX(a.connection_point.x);_vec3_1.setY(a.connection_point.y);_vec3_1.setZ(a.connection_point.z);_vec3_2.setX(a.wheel_direction.x);_vec3_2.setY(a.wheel_direction.y);_vec3_2.setZ(a.wheel_direction.z);_vec3_3.setX(a.wheel_axle.x);_vec3_3.setY(a.wheel_axle.y);_vec3_3.setZ(a.wheel_axle.z);_vehicles[a.id].addWheel(_vec3_1,_vec3_2,_vec3_3,a.suspension_rest_length,a.wheel_radius,b,a.is_front_wheel)}_num_wheels++;if(SUPPORT_TRANSFERABLE){vehiclereport=new Float32Array(1+_num_wheels*VEHICLEREPORT_ITEMSIZE);vehiclereport[0]=MESSAGE_TYPES.VEHICLEREPORT}else{vehiclereport=[MESSAGE_TYPES.VEHICLEREPORT]}};public_functions.setSteering=function(a){if(_vehicles[a.id]!==undefined){_vehicles[a.id].setSteeringValue(a.steering,a.wheel)}};public_functions.setBrake=function(a){if(_vehicles[a.id]!==undefined){_vehicles[a.id].setBrake(a.brake,a.wheel)}};public_functions.applyEngineForce=function(a){if(_vehicles[a.id]!==undefined){_vehicles[a.id].applyEngineForce(a.force,a.wheel)}};public_functions.removeObject=function(a){world.removeRigidBody(_objects[a.id]);Ammo.destroy(_objects[a.id]);Ammo.destroy(_motion_states[a.id]);if(_compound_shapes[a.id]){Ammo.destroy(_compound_shapes[a.id])}if(_noncached_shapes[a.id]){Ammo.destroy(_noncached_shapes[a.id])}var b=_objects[a.id].a!=undefined?_objects[a.id].a:_objects[a.id].ptr;delete _objects_ammo[b];delete _objects[a.id];delete _motion_states[a.id];if(_compound_shapes[a.id]){delete _compound_shapes[a.id]}if(_noncached_shapes[a.id]){delete _noncached_shapes[a.id]}_num_objects--};public_functions.updateTransform=function(a){_object=_objects[a.id];_object.getMotionState().getWorldTransform(_transform);if(a.pos){_vec3_1.setX(a.pos.x);_vec3_1.setY(a.pos.y);_vec3_1.setZ(a.pos.z);_transform.setOrigin(_vec3_1)}if(a.quat){_quat.setX(a.quat.x);_quat.setY(a.quat.y);_quat.setZ(a.quat.z);_quat.setW(a.quat.w);_transform.setRotation(_quat)}_object.setWorldTransform(_transform);_object.activate()};public_functions.updateMass=function(a){_object=_objects[a.id];world.removeRigidBody(_object);_vec3_1.setX(0);_vec3_1.setY(0);_vec3_1.setZ(0);_object.setMassProps(a.mass,_vec3_1);world.addRigidBody(_object);_object.activate()};public_functions.applyCentralImpulse=function(a){_vec3_1.setX(a.x);_vec3_1.setY(a.y);_vec3_1.setZ(a.z);_objects[a.id].applyCentralImpulse(_vec3_1);_objects[a.id].activate()};public_functions.applyImpulse=function(a){_vec3_1.setX(a.impulse_x);_vec3_1.setY(a.impulse_y);_vec3_1.setZ(a.impulse_z);_vec3_2.setX(a.x);_vec3_2.setY(a.y);_vec3_2.setZ(a.z);_objects[a.id].applyImpulse(_vec3_1,_vec3_2);_objects[a.id].activate()};public_functions.applyCentralForce=function(a){_vec3_1.setX(a.x);_vec3_1.setY(a.y);_vec3_1.setZ(a.z);_objects[a.id].applyCentralForce(_vec3_1);_objects[a.id].activate()};public_functions.applyForce=function(a){_vec3_1.setX(a.impulse_x);_vec3_1.setY(a.impulse_y);_vec3_1.setZ(a.impulse_z);_vec3_2.setX(a.x);_vec3_2.setY(a.y);_vec3_2.setZ(a.z);_objects[a.id].applyForce(_vec3_1,_vec3_2);_objects[a.id].activate()};public_functions.setAngularVelocity=function(a){_vec3_1.setX(a.x);_vec3_1.setY(a.y);_vec3_1.setZ(a.z);_objects[a.id].setAngularVelocity(_vec3_1);_objects[a.id].activate()};public_functions.setLinearVelocity=function(a){_vec3_1.setX(a.x);_vec3_1.setY(a.y);_vec3_1.setZ(a.z);_objects[a.id].setLinearVelocity(_vec3_1);_objects[a.id].activate()};public_functions.setAngularFactor=function(a){_vec3_1.setX(a.x);_vec3_1.setY(a.y);_vec3_1.setZ(a.z);_objects[a.id].setAngularFactor(_vec3_1)};public_functions.setLinearFactor=function(a){_vec3_1.setX(a.x);_vec3_1.setY(a.y);_vec3_1.setZ(a.z);_objects[a.id].setLinearFactor(_vec3_1)};public_functions.setDamping=function(a){_objects[a.id].setDamping(a.linear,a.angular)};public_functions.setCcdMotionThreshold=function(a){_objects[a.id].setCcdMotionThreshold(a.threshold)};public_functions.setCcdSweptSphereRadius=function(a){_objects[a.id].setCcdSweptSphereRadius(a.radius)};public_functions.addConstraint=function(d){var e;switch(d.type){case"point":if(d.objectb===undefined){_vec3_1.setX(d.positiona.x);_vec3_1.setY(d.positiona.y);_vec3_1.setZ(d.positiona.z);e=new Ammo.btPoint2PointConstraint(_objects[d.objecta],_vec3_1)}else{_vec3_1.setX(d.positiona.x);_vec3_1.setY(d.positiona.y);_vec3_1.setZ(d.positiona.z);_vec3_2.setX(d.positionb.x);_vec3_2.setY(d.positionb.y);_vec3_2.setZ(d.positionb.z);e=new Ammo.btPoint2PointConstraint(_objects[d.objecta],_objects[d.objectb],_vec3_1,_vec3_2)}break;case"hinge":if(d.objectb===undefined){_vec3_1.setX(d.positiona.x);_vec3_1.setY(d.positiona.y);_vec3_1.setZ(d.positiona.z);_vec3_2.setX(d.axis.x);_vec3_2.setY(d.axis.y);_vec3_2.setZ(d.axis.z);e=new Ammo.btHingeConstraint(_objects[d.objecta],_vec3_1,_vec3_2)}else{_vec3_1.setX(d.positiona.x);_vec3_1.setY(d.positiona.y);_vec3_1.setZ(d.positiona.z);_vec3_2.setX(d.positionb.x);_vec3_2.setY(d.positionb.y);_vec3_2.setZ(d.positionb.z);_vec3_3.setX(d.axis.x);_vec3_3.setY(d.axis.y);_vec3_3.setZ(d.axis.z);e=new Ammo.btHingeConstraint(_objects[d.objecta],_objects[d.objectb],_vec3_1,_vec3_2,_vec3_3,_vec3_3)}break;case"slider":var b,a,c;b=new Ammo.btTransform();_vec3_1.setX(d.positiona.x);_vec3_1.setY(d.positiona.y);_vec3_1.setZ(d.positiona.z);b.setOrigin(_vec3_1);var c=b.getRotation();c.setEuler(d.axis.x,d.axis.y,d.axis.z);b.setRotation(c);if(d.objectb){a=new Ammo.btTransform();_vec3_2.setX(d.positionb.x);_vec3_2.setY(d.positionb.y);_vec3_2.setZ(d.positionb.z);a.setOrigin(_vec3_2);c=a.getRotation();c.setEuler(d.axis.x,d.axis.y,d.axis.z);a.setRotation(c);e=new Ammo.btSliderConstraint(_objects[d.objecta],_objects[d.objectb],b,a,true)}else{e=new Ammo.btSliderConstraint(_objects[d.objecta],b,true)}Ammo.destroy(b);if(a!=undefined){Ammo.destroy(a)}break;case"conetwist":var b,a;b=new Ammo.btTransform();b.setIdentity();a=new Ammo.btTransform();a.setIdentity();_vec3_1.setX(d.positiona.x);_vec3_1.setY(d.positiona.y);_vec3_1.setZ(d.positiona.z);_vec3_2.setX(d.positionb.x);_vec3_2.setY(d.positionb.y);_vec3_2.setZ(d.positionb.z);b.setOrigin(_vec3_1);a.setOrigin(_vec3_2);var c=b.getRotation();c.setEulerZYX(-d.axisa.z,-d.axisa.y,-d.axisa.x);b.setRotation(c);c=a.getRotation();c.setEulerZYX(-d.axisb.z,-d.axisb.y,-d.axisb.x);a.setRotation(c);e=new Ammo.btConeTwistConstraint(_objects[d.objecta],_objects[d.objectb],b,a);e.setLimit(Math.PI,0,Math.PI);Ammo.destroy(b);Ammo.destroy(a);break;case"dof":var b,a,c;b=new Ammo.btTransform();b.setIdentity();_vec3_1.setX(d.positiona.x);_vec3_1.setY(d.positiona.y);_vec3_1.setZ(d.positiona.z);b.setOrigin(_vec3_1);c=b.getRotation();c.setEulerZYX(-d.axisa.z,-d.axisa.y,-d.axisa.x);b.setRotation(c);if(d.objectb){a=new Ammo.btTransform();a.setIdentity();_vec3_2.setX(d.positionb.x);_vec3_2.setY(d.positionb.y);_vec3_2.setZ(d.positionb.z);a.setOrigin(_vec3_2);c=a.getRotation();c.setEulerZYX(-d.axisb.z,-d.axisb.y,-d.axisb.x);a.setRotation(c);e=new Ammo.btGeneric6DofConstraint(_objects[d.objecta],_objects[d.objectb],b,a)}else{e=new Ammo.btGeneric6DofConstraint(_objects[d.objecta],b)}Ammo.destroy(b);if(a!=undefined){Ammo.destroy(a)}break;default:return}world.addConstraint(e);e.enableFeedback();_constraints[d.id]=e;_num_constraints++;if(SUPPORT_TRANSFERABLE){constraintreport=new Float32Array(1+_num_constraints*CONSTRAINTREPORT_ITEMSIZE);constraintreport[0]=MESSAGE_TYPES.CONSTRAINTREPORT}else{constraintreport=[MESSAGE_TYPES.CONSTRAINTREPORT]}};public_functions.removeConstraint=function(a){var b=_constraints[a.id];if(b!==undefined){world.removeConstraint(b);delete _constraints[a.id];_num_constraints--}};public_functions.constraint_setBreakingImpulseThreshold=function(a){var b=_constraints[a.id];if(b!==undefind){b.setBreakingImpulseThreshold(a.threshold)}};public_functions.simulate=function simulate(a){if(world){a=a||{};if(!a.timeStep){if(last_simulation_time){a.timeStep=0;while(a.timeStep+last_simulation_duration<=fixedTimeStep){a.timeStep=(Date.now()-last_simulation_time)/1000}}else{a.timeStep=fixedTimeStep}}else{if(a.timeStep<fixedTimeStep){a.timeStep=fixedTimeStep}}a.maxSubSteps=a.maxSubSteps||Math.ceil(a.timeStep/fixedTimeStep);last_simulation_duration=Date.now();world.stepSimulation(a.timeStep,a.maxSubSteps,fixedTimeStep);reportVehicles();reportCollisions();reportConstraints();reportWorld();last_simulation_duration=(Date.now()-last_simulation_duration)/1000;last_simulation_time=Date.now()}};public_functions.hinge_setLimits=function(a){_constraints[a.constraint].setLimit(a.low,a.high,0,a.bias_factor,a.relaxation_factor)};public_functions.hinge_enableAngularMotor=function(b){var a=_constraints[b.constraint];a.enableAngularMotor(true,b.velocity,b.acceleration);a.getRigidBodyA().activate();if(a.getRigidBodyB()){a.getRigidBodyB().activate()}};public_functions.hinge_disableMotor=function(a){_constraints[a.constraint].enableMotor(false);if(constraint.getRigidBodyB()){constraint.getRigidBodyB().activate()}};public_functions.slider_setLimits=function(b){var a=_constraints[b.constraint];a.setLowerLinLimit(b.lin_lower||0);a.setUpperLinLimit(b.lin_upper||0);a.setLowerAngLimit(b.ang_lower||0);a.setUpperAngLimit(b.ang_upper||0)};public_functions.slider_setRestitution=function(b){var a=_constraints[b.constraint];a.setSoftnessLimLin(b.linear||0);a.setSoftnessLimAng(b.angular||0)};public_functions.slider_enableLinearMotor=function(b){var a=_constraints[b.constraint];a.setTargetLinMotorVelocity(b.velocity);a.setMaxLinMotorForce(b.acceleration);a.setPoweredLinMotor(true);a.getRigidBodyA().activate();if(a.getRigidBodyB){a.getRigidBodyB().activate()}};public_functions.slider_disableLinearMotor=function(b){var a=_constraints[b.constraint];a.setPoweredLinMotor(false);if(a.getRigidBodyB()){a.getRigidBodyB().activate()}};public_functions.slider_enableAngularMotor=function(b){var a=_constraints[b.constraint];a.setTargetAngMotorVelocity(b.velocity);a.setMaxAngMotorForce(b.acceleration);a.setPoweredAngMotor(true);a.getRigidBodyA().activate();if(a.getRigidBodyB()){a.getRigidBodyB().activate()}};public_functions.slider_disableAngularMotor=function(b){var a=_constraints[b.constraint];a.setPoweredAngMotor(false);a.getRigidBodyA().activate();if(a.getRigidBodyB()){a.getRigidBodyB().activate()}};public_functions.conetwist_setLimit=function(a){_constraints[a.constraint].setLimit(a.z,a.y,a.x)};public_functions.conetwist_enableMotor=function(b){var a=_constraints[b.constraint];a.enableMotor(true);a.getRigidBodyA().activate();a.getRigidBodyB().activate()};public_functions.conetwist_setMaxMotorImpulse=function(b){var a=_constraints[b.constraint];a.setMaxMotorImpulse(b.max_impulse);a.getRigidBodyA().activate();a.getRigidBodyB().activate()};public_functions.conetwist_setMotorTarget=function(b){var a=_constraints[b.constraint];_quat.setX(b.x);_quat.setY(b.y);_quat.setZ(b.z);_quat.setW(b.w);a.setMotorTarget(_quat);a.getRigidBodyA().activate();a.getRigidBodyB().activate()};public_functions.conetwist_disableMotor=function(b){var a=_constraints[b.constraint];a.enableMotor(false);a.getRigidBodyA().activate();a.getRigidBodyB().activate()};public_functions.dof_setLinearLowerLimit=function(b){var a=_constraints[b.constraint];_vec3_1.setX(b.x);_vec3_1.setY(b.y);_vec3_1.setZ(b.z);a.setLinearLowerLimit(_vec3_1);a.getRigidBodyA().activate();if(a.getRigidBodyB()){a.getRigidBodyB().activate()}};public_functions.dof_setLinearUpperLimit=function(b){var a=_constraints[b.constraint];_vec3_1.setX(b.x);_vec3_1.setY(b.y);_vec3_1.setZ(b.z);a.setLinearUpperLimit(_vec3_1);a.getRigidBodyA().activate();if(a.getRigidBodyB()){a.getRigidBodyB().activate()}};public_functions.dof_setAngularLowerLimit=function(b){var a=_constraints[b.constraint];_vec3_1.setX(b.x);_vec3_1.setY(b.y);_vec3_1.setZ(b.z);a.setAngularLowerLimit(_vec3_1);a.getRigidBodyA().activate();if(a.getRigidBodyB()){a.getRigidBodyB().activate()}};public_functions.dof_setAngularUpperLimit=function(b){var a=_constraints[b.constraint];_vec3_1.setX(b.x);_vec3_1.setY(b.y);_vec3_1.setZ(b.z);a.setAngularUpperLimit(_vec3_1);a.getRigidBodyA().activate();if(a.getRigidBodyB()){a.getRigidBodyB().activate()}};public_functions.dof_enableAngularMotor=function(c){var b=_constraints[c.constraint];var a=b.getRotationalLimitMotor(c.which);a.set_m_enableMotor(true);b.getRigidBodyA().activate();if(b.getRigidBodyB()){b.getRigidBodyB().activate()}};public_functions.dof_configureAngularMotor=function(c){var b=_constraints[c.constraint];var a=b.getRotationalLimitMotor(c.which);a.set_m_loLimit(c.low_angle);a.set_m_hiLimit(c.high_angle);a.set_m_targetVelocity(c.velocity);a.set_m_maxMotorForce(c.max_force);b.getRigidBodyA().activate();if(b.getRigidBodyB()){b.getRigidBodyB().activate()}};public_functions.dof_disableAngularMotor=function(c){var b=_constraints[c.constraint];var a=b.getRotationalLimitMotor(c.which);a.set_m_enableMotor(false);b.getRigidBodyA().activate();if(b.getRigidBodyB()){b.getRigidBodyB().activate()}};reportWorld=function(){var d,c,b,a,f,g=0,e=0;if(SUPPORT_TRANSFERABLE){if(worldreport.length<2+_num_objects*WORLDREPORT_ITEMSIZE){worldreport=new Float32Array(2+(Math.ceil(_num_objects/REPORT_CHUNKSIZE)*REPORT_CHUNKSIZE)*WORLDREPORT_ITEMSIZE);worldreport[0]=MESSAGE_TYPES.WORLDREPORT}}worldreport[1]=_num_objects;for(d in _objects){if(_objects.hasOwnProperty(d)){c=_objects[d];b=c.getCenterOfMassTransform();a=b.getOrigin();f=b.getRotation();g=2+(e++)*WORLDREPORT_ITEMSIZE;worldreport[g]=c.id;worldreport[g+1]=a.x();worldreport[g+2]=a.y();worldreport[g+3]=a.z();worldreport[g+4]=f.x();worldreport[g+5]=f.y();worldreport[g+6]=f.z();worldreport[g+7]=f.w();_vector=c.getLinearVelocity();worldreport[g+8]=_vector.x();worldreport[g+9]=_vector.y();worldreport[g+10]=_vector.z();_vector=c.getAngularVelocity();worldreport[g+11]=_vector.x();worldreport[g+12]=_vector.y();worldreport[g+13]=_vector.z()}}if(SUPPORT_TRANSFERABLE){transferableMessage(worldreport.buffer,[worldreport.buffer])}else{transferableMessage(worldreport)}};reportCollisions=function(){var f,c,b=world.getDispatcher(),g=b.getNumManifolds(),e,h,d,k,a=false;if(SUPPORT_TRANSFERABLE){if(collisionreport.length<2+g*COLLISIONREPORT_ITEMSIZE){collisionreport=new Float32Array(2+(Math.ceil(_num_objects/REPORT_CHUNKSIZE)*REPORT_CHUNKSIZE)*COLLISIONREPORT_ITEMSIZE);collisionreport[0]=MESSAGE_TYPES.COLLISIONREPORT}}collisionreport[1]=0;for(f=0;f<g;f++){e=b.getManifoldByIndexInternal(f);h=e.getNumContacts();if(h===0){continue}for(d=0;d<h;d++){k=e.getContactPoint(d);c=2+(collisionreport[1]++)*COLLISIONREPORT_ITEMSIZE;collisionreport[c]=_objects_ammo[e.getBody0()];collisionreport[c+1]=_objects_ammo[e.getBody1()];_vector=k.get_m_normalWorldOnB();collisionreport[c+2]=_vector.x();collisionreport[c+3]=_vector.y();collisionreport[c+4]=_vector.z();break;transferableMessage(_objects_ammo)}}if(SUPPORT_TRANSFERABLE){transferableMessage(collisionreport.buffer,[collisionreport.buffer])}else{transferableMessage(collisionreport)}};reportVehicles=function(){var d,h,c,a,f,g=0,e=0,b=0;if(SUPPORT_TRANSFERABLE){if(vehiclereport.length<2+_num_wheels*VEHICLEREPORT_ITEMSIZE){vehiclereport=new Float32Array(2+(Math.ceil(_num_wheels/REPORT_CHUNKSIZE)*REPORT_CHUNKSIZE)*VEHICLEREPORT_ITEMSIZE);vehiclereport[0]=MESSAGE_TYPES.VEHICLEREPORT}}for(d in _vehicles){if(_vehicles.hasOwnProperty(d)){h=_vehicles[d];for(b=0;b<h.getNumWheels();b++){c=h.getWheelInfo(b).get_m_worldTransform();a=c.getOrigin();f=c.getRotation();g=1+(e++)*VEHICLEREPORT_ITEMSIZE;vehiclereport[g]=d;vehiclereport[g+1]=b;vehiclereport[g+2]=a.x();vehiclereport[g+3]=a.y();vehiclereport[g+4]=a.z();vehiclereport[g+5]=f.x();vehiclereport[g+6]=f.y();vehiclereport[g+7]=f.z();vehiclereport[g+8]=f.w()}}}if(b!==0){if(SUPPORT_TRANSFERABLE){transferableMessage(vehiclereport.buffer,[vehiclereport.buffer])}else{transferableMessage(vehiclereport)}}};reportConstraints=function(){var d,f,c,b,a,g=0,e=0;if(SUPPORT_TRANSFERABLE){if(constraintreport.length<2+_num_constraints*CONSTRAINTREPORT_ITEMSIZE){constraintreport=new Float32Array(2+(Math.ceil(_num_constraints/REPORT_CHUNKSIZE)*REPORT_CHUNKSIZE)*CONSTRAINTREPORT_ITEMSIZE);constraintreport[0]=MESSAGE_TYPES.CONSTRAINTREPORT}}for(d in _constraints){if(_constraints.hasOwnProperty(d)){f=_constraints[d];c=f.getRigidBodyA();b=f.getFrameOffsetA();a=b.getOrigin();g=1+(e++)*CONSTRAINTREPORT_ITEMSIZE;constraintreport[g]=d;constraintreport[g+1]=c.id;constraintreport[g+2]=a.getX();constraintreport[g+3]=a.getY();constraintreport[g+4]=a.getZ();constraintreport[g+5]=f.getAppliedImpulse()}}if(e!==0){if(SUPPORT_TRANSFERABLE){transferableMessage(constraintreport.buffer,[constraintreport.buffer])}else{transferableMessage(constraintreport)}}};self.onmessage=function(a){if(a.data instanceof Float32Array){switch(a.data[0]){case MESSAGE_TYPES.WORLDREPORT:worldreport=new Float32Array(a.data);break;case MESSAGE_TYPES.COLLISIONREPORT:collisionreport=new Float32Array(a.data);break;case MESSAGE_TYPES.VEHICLEREPORT:vehiclereport=new Float32Array(a.data);break;case MESSAGE_TYPES.CONSTRAINTREPORT:constraintreport=new Float32Array(a.data);break}return}if(a.data.cmd&&public_functions[a.data.cmd]){public_functions[a.data.cmd](a.data.params)}};